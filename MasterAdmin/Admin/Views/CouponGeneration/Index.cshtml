
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    var coupons = (List<Admin.Models.tblCouponGroup>)ViewData["CouponData"];

    Admin.Models.JAVADBEntities db = new Admin.Models.JAVADBEntities();
}

<div class="FormBlock">
    <form id="frmCoupon">
        <div class="row">
            <div class="col-sm-12">
                <div class="MainHeader">Manage Discount Coupons</div>
            </div>

            <div class="col-sm-3"><div class="FormLabelStyle">Event Name</div></div>
            <div class="col-sm-5">
                <select class="FormTxtStyle" id="drpEventID" name="drpEventID">
                    <option value="">--Select Event Name--</option>
                    @foreach (var evt in (List<Admin.Models.tblEvent>)ViewData["Events"])
                    {
                        <option value="@evt.EventID">@evt.EventName</option>
                    }
                </select>
            </div>
            <div class="col-sm-4"><div class="FormValidationStyle" id="lblEventName"></div></div>
            <div class="col-sm-12"><br /></div>

            <div class="col-sm-3" id="divSeat1" style="display:none;"><div class="FormLabelStyle">Blocks for Discount</div></div>
            <div class="col-sm-5" id="divSeat2" style="display:none;">

                <div id="divSeats">

                </div>

            </div>
            <div class="col-sm-4" id="divSeat3" style="display:none;"><div class="FormValidationStyle" id="lblEventDate"></div></div>
            <div class="col-sm-12" id="divSeat4" style="display:none;"><br /></div>

            <div class="col-sm-3"><div class="FormLabelStyle">Discount Variant</div></div>
            <div class="col-sm-5">
                <select class="FormTxtStyle" id="drpDiscountVariant" name="drpDiscountVariant">
                    <option value="">--Select Discount Variant--</option>
                    <option value="ONETOMANY">One Discount Code to Multiple User</option>
                    <option value="ONETOONE">One Discount Code for Single User</option>
                </select>
            </div>
            <div class="col-sm-4"><div class="FormValidationStyle" id="lbldrpDiscountVariant"></div></div>
            <div class="col-sm-12"><br /></div>

            <div class="col-sm-3"><div class="FormLabelStyle">Discount In</div></div>
            <div class="col-sm-5">
                <select class="FormTxtStyle" id="drpDiscountIn" name="drpDiscountIn">
                    <option value="">--Select Discount Type--</option>
                    <option value="Percentage">Percentage</option>
                    <option value="Value">Value</option>
                </select>
            </div>
            <div class="col-sm-4"><div class="FormValidationStyle" id="lblEventName"></div></div>
            <div class="col-sm-12"><br /></div>



            <div class="col-sm-3"><div class="FormLabelStyle">Coupon Prefix</div></div>
            <div class="col-sm-5"><input type="text" class="FormTxtStyle" id="txtPrefix" name="txtPrefix" /></div>
            <div class="col-sm-4"><div class="FormValidationStyle" id="lblPrefix"></div></div>
            <div class="col-sm-12"><br /></div>

            <div class="col-sm-3"><div class="FormLabelStyle">No. of Discount Coupons</div></div>
            <div class="col-sm-5"><input type="text" class="FormTxtStyle" id="txtNoOfCoupons" name="txtNoOfCoupons" /></div>
            <div class="col-sm-4"><div class="FormValidationStyle" id="lblNoOfCoupons"></div></div>
            <div class="col-sm-12"><br /></div>

            <div class="col-sm-3"><div class="FormLabelStyle">Discount Percentage/Value</div></div>
            <div class="col-sm-5"><input type="text" class="FormTxtStyle" id="txtPercentage" name="txtPercentage" /></div>
            <div class="col-sm-4"><div class="FormValidationStyle" id="lblPercentage"></div></div>
            <div class="col-sm-12"><br /></div>

            <div class="col-sm-3"><div class="FormLabelStyle"></div></div>
            <div class="col-sm-5"><button class="FormBtnStyle" type="button" id="but_upload" onclick="GenerateCoupons();">Generate Coupons</button><img id="but_loader" src="~/App_Images/loader.gif" style="height:20px!important;width:20px!important;display:none;" /></div>
            <div class="col-sm-4"><div class="FormValidationStyle"></div></div>
            <div class="col-sm-12"><br /></div>
        </div>
    </form>
</div>

<div class="FormBlock">
    <div class="row">
        <div class="col-sm-12">
            <div class="MainHeader">List of Coupons Generated</div>
        </div>

        <div class="col-sm-12">
            <div class="underline"></div>
        </div>
    </div>

    <div class="row">

        <div class="col-sm-12">

            <table id="datatable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th><center>Sr No</center></th>
                        <th><center>Event Name</center></th>
                        <th><center>Coupons Generated</center></th>
                        <th><center>Discount Variant</center></th>
                        <th><center>Discount In</center></th>
                        <th><center>Discount</center></th>
                        <th><center>Tiers</center></th>
                        <th><center>Coupons Redeemed</center></th>
                        <th><center>Action</center></th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int i = 0;
                    }
                    @foreach (var coupon in coupons)
                    {
                        i++;

                        var evt = db.tblEvents.Where(t => t.EventID == coupon.EventID).SingleOrDefault();
                        int cs = db.tblCoupons.Where(t => t.CouponGroupID == coupon.CouponGroupID).Count();
                        var couponsUsed = db.tblOrderCoupons.Where(e => e.tblCoupon.CouponGroupID == coupon.CouponGroupID && e.OrderID != null).Count();

                        if (evt != null)
                        {

                            if (!string.IsNullOrEmpty(coupon.Tiers))
                            {
                                var tiers = db.tblTiers.SqlQuery("SELECT * FROM TBLTIER WHERE TIERID IN (" + coupon.Tiers + ")").ToList();
                                <tr>
                                    <td><center>@i</center></td>
                                    <td><center>@evt.EventName</center></td>
                                    <td><center>@cs</center></td>
                                    <td>@*<center>@coupon.DiscountIn</center>*@</td>
                                    <td><center>@coupon.DiscountIn</center></td>
                                    <td><center>@((coupon.DiscountIn == "Percentage" ? Decimal.Round(Convert.ToDecimal(coupon.Discount)) + "%" : Decimal.Round(Convert.ToDecimal(coupon.Discount)).ToString()))</center></td>
                                    <td><center>@(tiers.Count() > 0 ? string.Join(",", tiers.Select(t => t.TierName)) : "")</center></td>
                                    <td><center>@couponsUsed</center></td>
                                    <td><center><a href="/CouponGeneration/ExportCoupons?groupID=@coupon.CouponGroupID">Download</a></center></td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="~/App_Scripts/jquery.validate.js"></script>
<script type="text/javascript">
    $(function () {

        $("#frmCoupon").validate({
            rules: {
                drpEventID: {
                    required: true
                },
                txtPrefix: {
                    required: true
                },
                drpDiscountVariant: {
                    required: true
                },
                txtNoOfCoupons: {
                    required: true,
                    number: true
                },
                txtPercentage: {
                    required: true,
                    number: true
                }
            },
            messages: {
                drpEventID: {
                    required: "Please select event"
                },
                txtPrefix: {
                    required: "Please enter prefix"
                },
                drpDiscountVariant: {
                    required: "Please select coupon variant"
                },
                txtNoOfCoupons: {
                    required: "Please enter number of coupons",
                    number: "Number of coupons should be digits"
                },
                txtPercentage: {
                    required: "Please enter percentage",
                    number: "Percentage should be digits"
                }
            },
            errorPlacement: function (error, element) {
                if (element.attr("name") == "drpEventID")
                    error.appendTo($('#lblEventName'));

                if (element.attr("name") == "txtPrefix")
                    error.appendTo($('#lblPrefix'));

                if (element.attr("name") == "drpDiscountVariant")
                    error.appendTo($('#lbldrpDiscountVariant'));

                if (element.attr("name") == "txtNoOfCoupons")
                    error.appendTo($('#lblNoOfCoupons'));

                if (element.attr("name") == "txtPercentage")
                    error.appendTo($('#lblPercentage'));
            }
        });

        $("#drpEventID").change(function () {
            GetTiers($(this).val());
        });
    });



    function GenerateCoupons() {
        if ($("#frmCoupon").valid()) {
            $("#but_upload").hide();
            $("#but_loader").show();

            $.ajax({
                url: "/CouponGeneration/Generate",
                data: $("#frmCoupon").serialize(),
                type: "POST",
                success: function (response) {
                    if (response == "OK") {
                        alert("Coupons generated successfully.");
                        location.reload();
                    }
                    else {

                        alert("Sorry, something went wrong. Please try again after sometime.")
                        $("#but_loader").hide();
                        $("#but_upload").show();
                    }
                }
            });
        }
        else
            return false;
    }

    function GetTiers(id) {
        $.ajax({
            url: "/CouponGeneration/GetTiers",
            data: { eventID: id },
            type: "GET",
            success: function (response) {
                var chk = '';
                chk += '<div class="">';
                $.each(response, function (key, value) {
                    chk += '<div style="width:200px; font-size:14px; background:#ededed; font-weight:bold; padding:10px; border:1px solid #ededed; margin:0px 0 20px 0;"><input type="checkbox" class="chkSeats" name="tiers" value="' + value.tierID + '" /> ' + value.TierName + ' - ' + '$' + value.Price + '</div>';
                });
                chk += '</div>';


                $("#divSeats").html(chk);

                $("#divPrice1").show();
                $("#divPrice2").show();
                $("#divPrice3").show();
                $("#divPrice4").show();

                $("#divSeat1").show();
                $("#divSeat2").show();
                $("#divSeat3").show();
                $("#divSeat4").show();
            }
        });
    }

</script>