@{
    ViewBag.Title = "Past Events";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@model Admin.Models.EventsViewModel

@{
    var events = (List<Admin.Models.EventsViewModel>)TempData["ListEvents"];
    var eventsRequest = (Admin.Models.EventRequest)TempData["EventRequest"];
    var eventId = TempData["eventID"];
    var searchEvent = (Admin.Models.EventsViewModel)TempData["SearchEvents"];
    var eventImageList = (List<Admin.Models.EventsImageListViewModel>)TempData["eventImageList"];
}


<script src="~/App_Scripts/jquery.validate.js"></script>

<form id="frmEvent">
    <div class="row">
        <div class="col-sm-12">
            <div class="MainHeader">Manage Gallery Past Events</div>
        </div>
        @if (searchEvent != null )
        {
            <div class="col-sm-12">
                <div class="bs-callout bs-callout-danger">
                    <div class="cheading">
                        <h3 class="ctitle">@searchEvent.EventName</h3>
                    </div>
                    <div class="cbody">
                        @searchEvent.EventDate.ToLongDateString()
                    </div>
                    @*<div class="panel-footer"></div>*@
                </div>
                @*@Model.EventName
                    
                @Model.EventDate*@
            </div>
        }
        @*Event Name*@
            <div>
                @*<div class="col-sm-3"><div class="FormLabelStyle">Venue</div></div>*@
                <div class="col-sm-3"></div>
                    <div class="col-sm-4">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle w-100"
                                    type="button" id="dropdownMenuButton"
                                    data-toggle="dropdown" aria-expanded="false">
                                Select Events &nbsp;<i class="fa fa-angle-down"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                @foreach (var item in events)
                                {
                                    <li>
                                        @Html.ActionLink(item.EventName + " - [ " + Convert.ToDateTime(item.EventDate).ToShortDateString() + " ]", "SearchEvents", "AddPastEvents"
                                        , new
                                        {
                                            EventId = item.EventID,
                                            pageNum = eventsRequest.pageNum,
                                            rowsPerPage = eventsRequest.rowsPerPage
                                        }
                                        , null
                                        )
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                    @*<div class="col-sm-5">
                <select class="FormTxtStyle" id="drpMediaType" name="drpMediaType">
                    <option value="select">--Select Media Type--</option>
                    <option value="image">Image</option>
                    <option value="video">Video</option>
                </select>
            </div>*@
                    <div class="col-sm-4"><div class="FormValidationStyle" id="lblMediaType"></div></div>
                    <div class="col-sm-12"><br /></div>

                </div>
                @*Event Name*@
                <div class="col-sm-3"><div class="FormLabelStyle">Upload Images</div></div>
                <div class="col-sm-5">
                    <label for="txtFile" class="addImageThumb">
                        <i class="glyphicon glyphicon-plus"></i>
                    </label>
                    <input type="file" class="FormTxtStyle" id="txtFile" name="txtFile" multiple />
                </div>
                <div class="col-sm-4"><div class="FormValidationStyle" id="lblFile"></div></div>
                <div class="col-sm-12"><br /></div>
                @*Event Name*@
                <div class="col-sm-3"><div class="FormLabelStyle"></div></div>
                <div class="col-sm-5"><button class="FormBtnStyle" type="button" id="but_upload" onclick="UploadFiles();">Upload Images</button><img id="but_loader" src="~/App_Images/loader.gif" style="height:20px!important;width:20px!important;display:none;" /></div>
                <div class="col-sm-4"><div class="FormValidationStyle"></div></div>
                <div class="col-sm-12"><br /></div>
                @if (searchEvent != null)
                {
                    <div class="col-sm-12">
                        <div class="ev-header">
                            @searchEvent.EventName
                        </div>
                        <div class="ev-content">
                            @if (eventImageList.Count > 0)
                            {
                                <div id="grid" class="container">
                                    @foreach (var item in eventImageList)
                                    {
                                        if (item.ImageType == "video/mp4")
                                        {
                                            <div class="grid-item video">
                                                <video controls>
                                                    <source src="~/PastEventImages/3040/@item.ImagePath" type="video/mp4" />
                                                </video>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="grid-item">
                                                @*<a  class="big" rel="rel1">
                                        </a>*@
                                                <img src="~/PastEventImages/3040/@item.ImagePath" alt="" title="Image 1">
                                            </div>
                                        }
                                    }
                                </div>
                                <script>
                                    $(document).ready(function () {
                                        var $grid = $('#grid').imagesLoaded().done(function () {
                                            // init Masonry after all images have loaded
                                            console.log("loaded");
                                            $('#grid').masonry({
                                                itemSelector: '.grid-item',
                                                columnWidth: 200,
                                                gutterWidth: 15
                                            });
                                        });
                                        document.querySelectorAll('video').forEach(vid =>
                                            vid.addEventListener('loadeddata', (event) => {
                                                console.log("loadeddata");
                                                $grid.masonry('layout');
                                            })
                                        )
                                    });
                                </script>
                            }
                            else
                            {
                                <div class="container">
                                    No Images found.
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
</form>

<script type="text/javascript">
        $(function () {

            $('#datatable').DataTable({
                "order": [[1, "asc"]]
            });

            $("#frmEvent").validate({
                rules: {
                    drpMediaType: {
                        required: true
                    },
                    txtFile: {
                        required: true,
                    }
                },
                messages: {
                    drpMediaType: {
                        required: "Please select media type"
                    },
                    txtFile: {
                        required: "Select atleast one file",
                    }
                },
                errorPlacement: function (error, element) {
                    if (element.attr("name") == "drpMediaType")
                        error.appendTo($('#lblMediaType'));
                    if (element.attr("name") == "txtFile")
                        error.appendTo($('#lblFile'));
                }
            });


        });


        function UploadFiles() {
            if ($("#frmEvent").valid()) {
                $("#but_upload").hide();
                $("#but_loader").show();
                var eventId = 3040;
                var data;
                data = new FormData();
                data.append('drpMediaType', $("#drpMediaType").val());
                data.append('eventID', eventId);

                var files = document.getElementById("txtFile").files;

                if (files.length > 0) {
                    for (var i = 0; i < files.length; i++) {
                        data.append('txtFile_' + i, files[i])
                    }
                }

                if (data != null) {
                    $.ajax({
                        url: "/AddPastEvents/UploadFiles",
                        data: data,
                        type: "POST",
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response == "OK") {
                                alert("Images added successfully.");
                                location.reload();
                            }
                            else {
                                alert("Sorry, something went wrong. Please try again after sometime.")
                                $("#but_loader").hide();
                                $("#but_upload").show();
                            }
                        }
                    });
                }
            }
            else
                return false;
        }

        function DeleteImage(id) {
            var c = confirm("Are you sure you want to delete this image?");

            if (c) {
                $.ajax({
                    url: "/AddPastEvents/DeleteImage?id=" + id,
                    type: "GET",
                    success: function (response) {
                        if (response == "OK") {
                            alert("Image deleted successfully.");
                            location.reload();
                        }
                    }
                });
            }
        }
</script>
